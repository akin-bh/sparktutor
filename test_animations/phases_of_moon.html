<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üåô Moon Phases ‚Äî Lunar Cycle</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    :root { 
      --bg: #0a0e1a; 
      --panel: #1a1f2e; 
      --text: #e8eef6; 
      --muted: #9bb0c3; 
      --accent: #4a9eff; 
      --sun-color: #ffed4a;
      --earth-color: #4a9eff;
      --moon-color: #d4d4d8;
    }
    * { box-sizing: border-box }
    html, body { 
      height: 100%; 
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial;
    }
    .wrap { 
      display: grid; 
      grid-template-columns: 260px 1fr; 
      grid-template-rows: auto 1fr; 
      gap: 10px; 
      padding: 10px; 
      height: 100% 
    }
    header { 
      grid-column: 1 / -1; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.1), rgba(255, 237, 74, 0.05)); 
      border: 1px solid rgba(255, 255, 255, 0.12); 
      border-radius: 12px; 
      padding: 12px 16px;
      backdrop-filter: blur(10px);
    }
    header h1 { 
      font-size: 18px; 
      margin: 0; 
      font-weight: 600; 
      background: linear-gradient(135deg, var(--accent), var(--sun-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    header .small { 
      color: var(--muted); 
      font-size: 12px; 
      margin-left: 8px;
      font-weight: normal;
      -webkit-text-fill-color: var(--muted);
    }
    .panel { 
      background: var(--panel); 
      border: 1px solid rgba(255, 255, 255, 0.1); 
      border-radius: 12px; 
      padding: 16px; 
      overflow: auto;
      backdrop-filter: blur(10px);
    }
    canvas { 
      width: 100%; 
      height: 100%; 
      display: block; 
      background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a1a 70%, #000000 100%); 
      border: 1px solid rgba(255, 255, 255, 0.1); 
      border-radius: 12px;
      position: relative;
    }
    .control { 
      margin: 12px 0 18px 
    }
    .control label { 
      font-size: 13px; 
      color: var(--muted); 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 8px 
    }
    .row { 
      display: flex; 
      gap: 8px; 
      align-items: center 
    }
    button { 
      background: rgba(255, 255, 255, 0.05); 
      border: 1px solid rgba(255, 255, 255, 0.15); 
      color: var(--text); 
      border-radius: 8px; 
      padding: 8px 12px; 
      font-size: 12px; 
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    button:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.25);
    }
    button.primary { 
      background: var(--accent); 
      color: #001428; 
      border: none;
      font-weight: 600;
    }
    button.primary:hover {
      background: #5aa3ff;
    }
    .kpi { 
      display: grid; 
      grid-template-columns: repeat(2, 1fr); 
      gap: 8px; 
      margin-top: 12px 
    }
    .kpi div { 
      background: rgba(0, 0, 0, 0.3); 
      border: 1px solid rgba(255, 255, 255, 0.1); 
      padding: 12px; 
      border-radius: 8px; 
      font-size: 12px;
      text-align: center;
    }
    .kpi .v { 
      font-size: 16px; 
      color: var(--accent); 
      font-weight: 600;
      display: block;
      margin-top: 4px;
    }
    .tag { 
      font-size: 11px; 
      color: var(--muted);
      line-height: 1.4;
    }
    .phase-display { 
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.1), rgba(255, 237, 74, 0.05)); 
      border: 1px solid rgba(255, 255, 255, 0.15); 
      border-radius: 10px; 
      padding: 16px; 
      margin: 12px 0; 
      text-align: center;
      backdrop-filter: blur(5px);
    }
    .phase-display .big { 
      font-size: 18px; 
      font-weight: 600; 
      color: var(--accent);
      margin-bottom: 6px;
    }
    .phase-display .desc { 
      font-size: 13px; 
      color: var(--muted); 
      margin-bottom: 8px;
      line-height: 1.3;
    }
    .phase-display .illumination {
      font-size: 24px;
      font-weight: 700;
      color: var(--sun-color);
      text-shadow: 0 0 10px rgba(255, 237, 74, 0.3);
    }
    input[type="range"] { 
      width: 100%; 
      accent-color: var(--accent);
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.1);
    }
    .view-toggle { 
      display: flex; 
      gap: 4px; 
      margin: 12px 0;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 4px;
    }
    .view-toggle button { 
      padding: 8px 12px;
      flex: 1;
      border-radius: 6px;
    }
    .view-toggle button.active { 
      background: var(--accent); 
      color: #001428 
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 12px;
      color: var(--muted);
    }
    input[type="checkbox"] {
      accent-color: var(--accent);
    }
    .moon-phase-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 12px 0;
    }
    .mini-moon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--moon-color);
      position: relative;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    }
    /* small consistent topbar for animations */
    .anim-topbar {
      position: absolute;
      top: 12px;
      left: 12px;
      right: 12px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      z-index: 30;
      font-weight: 700;
    }
    .anim-topbar .anim-title { color: var(--accent); font-size: 14px; }
    .anim-topbar .anim-controls { display:flex; gap:8px; align-items:center; }
    .anim-topbar .mini-btn { background:#0f1724; color:var(--text); border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Phases of the Moon <span class="small">illumination geometry</span></h1>
    <div class="row">
      <button id="btn-play" class="primary">‚ñ∂ Play Orbit</button>
      <button id="btn-pause">‚è∏ Pause</button>
      <button id="btn-reset">üîÑ Reset</button>
    </div>
  </header>

  <aside class="panel">
    <div class="control">
      <label>Moon Position <span><span id="lbl-position">0</span>¬∞</span></label>
      <input id="rng-position" type="range" min="0" max="360" step="1" value="0">
    </div>
    
    <div class="control">
      <label>Orbit Speed <span><span id="lbl-speed">30</span>¬∞/s</span></label>
      <input id="rng-speed" type="range" min="5" max="90" step="5" value="30">
    </div>
    
    <div class="view-toggle">
      <button id="btn-space-view" class="active">üöÄ Space View</button>
      <button id="btn-earth-view">üåç Earth View</button>
    </div>
    
    <div class="grid">
      <div class="checkbox-row">
        <input type="checkbox" id="chk-sunlight" checked>
        <label for="chk-sunlight">‚òÄÔ∏è Show Sunlight</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="chk-orbit" checked>
        <label for="chk-orbit">‚≠ï Orbit Path</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="chk-labels" checked>
        <label for="chk-labels">üè∑Ô∏è Labels</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="chk-earth-shadow">
        <label for="chk-earth-shadow">üåë Earth Shadow</label>
      </div>
    </div>

    <div class="phase-display">
      <div class="big" id="phase-name">New Moon</div>
      <div class="desc" id="phase-desc">Moon between Earth and Sun</div>
      <div class="moon-phase-indicator">
        <div class="mini-moon" id="mini-moon"></div>
      </div>
      <div class="illumination" id="phase-illumination">0%</div>
      <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">illuminated</div>
    </div>

    <div class="kpi">
      <div>üåô Moon Age<span id="kpi-age" class="v">0.0 days</span></div>
      <div>üìê Angular Distance<span id="kpi-angle" class="v">0¬∞</span></div>
      <div>üåÖ Rise Time<span id="kpi-rise" class="v">6:00 AM</span></div>
      <div>üåá Set Time<span id="kpi-set" class="v">6:00 PM</span></div>
    </div>
    
    <div class="tag" style="margin-top: 12px;">
      üí° <strong>Tip:</strong> Switch between Space and Earth view to understand how Moon phases work! The Sun always illuminates half the Moon - phases depend on viewing angle.
    </div>
  </aside>

  <main class="panel" style="padding: 0; position: relative">
    <div class="anim-topbar" role="toolbar" aria-label="Animation controls">
      <div class="anim-title">üåô Moon Phases</div>
      <div class="anim-controls">
        <button class="mini-btn" id="playPauseBtn">‚èØÔ∏è</button>
        <button class="mini-btn" id="closeBtn">‚úñ</button>
      </div>
    </div>
    <canvas id="cv"></canvas>
    <div id="phase-label" style="position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 6px; font-size: 14px; font-weight: 600; backdrop-filter: blur(5px);"></div>
  </main>
</div>

<script>
(() => {
  const canvas = document.getElementById('cv');
  const ctx = canvas.getContext('2d');
  let W = 1280, H = 720, DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  
  function resize() {
    const r = canvas.getBoundingClientRect();
    W = Math.max(640, Math.floor(r.width)); 
    H = Math.max(360, Math.floor(r.height));
    canvas.width = Math.floor(W * DPR); 
    canvas.height = Math.floor(H * DPR);
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
  }
  
  window.addEventListener('resize', resize);
  resize();

  // Enhanced animation state
  let moonAngle = 0;
  let isPlaying = false;
  let lastTime = 0;
  let orbitSpeed = 30; // degrees per second
  let isSpaceView = true;

  // UI Elements
  const positionEl = document.getElementById('rng-position');
  const speedEl = document.getElementById('rng-speed');
  const sunlightEl = document.getElementById('chk-sunlight');
  const orbitEl = document.getElementById('chk-orbit');
  const labelsEl = document.getElementById('chk-labels');
  const earthShadowEl = document.getElementById('chk-earth-shadow');

  // Enhanced phase calculation with more accurate astronomy
  function getPhaseInfo(angle) {
    const normalizedAngle = ((angle % 360) + 360) % 360;
    let phaseName, phaseDesc, illumination;

    // More accurate phase boundaries
    if (normalizedAngle < 22.5 || normalizedAngle >= 337.5) {
      phaseName = "New Moon";
      phaseDesc = "Moon between Earth and Sun";
      illumination = 0;
    } else if (normalizedAngle < 67.5) {
      phaseName = "Waxing Crescent";
      phaseDesc = "Growing sliver of light";
      illumination = Math.round(25 * (normalizedAngle - 22.5) / 45);
    } else if (normalizedAngle < 112.5) {
      phaseName = "First Quarter";
      phaseDesc = "Right half illuminated";
      illumination = 50;
    } else if (normalizedAngle < 157.5) {
      phaseName = "Waxing Gibbous";
      phaseDesc = "More than half lit";
      illumination = 50 + Math.round(25 * (normalizedAngle - 112.5) / 45);
    } else if (normalizedAngle < 202.5) {
      phaseName = "Full Moon";
      phaseDesc = "Completely illuminated";
      illumination = 100;
    } else if (normalizedAngle < 247.5) {
      phaseName = "Waning Gibbous";
      phaseDesc = "More than half lit, decreasing";
      illumination = 75 - Math.round(25 * (normalizedAngle - 202.5) / 45);
    } else if (normalizedAngle < 292.5) {
      phaseName = "Last Quarter";
      phaseDesc = "Left half illuminated";
      illumination = 50;
    } else {
      phaseName = "Waning Crescent";
      phaseDesc = "Shrinking sliver of light";
      illumination = Math.round(25 * (337.5 - normalizedAngle) / 45);
    }

    return { phaseName, phaseDesc, illumination, normalizedAngle };
  }

  function updatePhaseInfo() {
    const phase = getPhaseInfo(moonAngle);
    
    document.getElementById('phase-name').textContent = phase.phaseName;
    document.getElementById('phase-desc').textContent = phase.phaseDesc;
    document.getElementById('phase-illumination').textContent = phase.illumination + '%';
    document.getElementById('phase-label').textContent = phase.phaseName + ' - ' + phase.illumination + '% illuminated';
    
    // Update mini moon visual
    updateMiniMoon(phase.illumination, phase.normalizedAngle);
    
    // More accurate moon age calculation (29.53 days lunar cycle)
    const moonAge = (phase.normalizedAngle / 360) * 29.53;
    document.getElementById('kpi-age').textContent = moonAge.toFixed(1) + ' days';
    document.getElementById('kpi-angle').textContent = phase.normalizedAngle.toFixed(0) + '¬∞';
    
    // More accurate rise/set times based on phase
    const riseHour = 6 + (phase.normalizedAngle / 360) * 24;
    const setHour = (18 + (phase.normalizedAngle / 360) * 24) % 24;
    
    function formatTime(hour) {
      const h = Math.floor(hour % 24);
      const m = Math.floor((hour % 1) * 60);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const displayH = h === 0 ? 12 : h > 12 ? h - 12 : h;
      return `${displayH}:${m.toString().padStart(2, '0')} ${ampm}`;
    }
    
    document.getElementById('kpi-rise').textContent = formatTime(riseHour);
    document.getElementById('kpi-set').textContent = formatTime(setHour);
  }

  function updateMiniMoon(illumination, angle) {
    const miniMoon = document.getElementById('mini-moon');
    const shadowWidth = 100 - illumination;
    
    // Create a more accurate visual representation
    if (illumination === 0) {
      miniMoon.style.background = '#333';
      miniMoon.style.boxShadow = 'inset 0 0 20px rgba(0,0,0,0.8)';
    } else if (illumination === 100) {
      miniMoon.style.background = '#d4d4d8';
      miniMoon.style.boxShadow = '0 0 15px rgba(255, 255, 255, 0.4)';
    } else {
      const isWaxing = angle < 180;
      const shadowSide = isWaxing ? 'left' : 'right';
      miniMoon.style.background = `linear-gradient(to ${shadowSide}, #333 ${shadowWidth}%, #d4d4d8 ${shadowWidth}%)`;
      miniMoon.style.boxShadow = '0 0 15px rgba(255, 255, 255, 0.2)';
    }
  }

  // Enhanced drawing functions with better visuals
  function drawSpaceView() {
    const centerX = W / 2;
    const centerY = H / 2;
    const orbitRadius = Math.min(W, H) * 0.28;
    
    // Enhanced sun with better glow effect
    const sunX = centerX - W * 0.32;
    const sunY = centerY;
    
    ctx.save();
    
    // Sun glow effect
    const sunGradient = ctx.createRadialGradient(sunX, sunY, 0, sunX, sunY, 50);
    sunGradient.addColorStop(0, '#ffff00');
    sunGradient.addColorStop(0.7, '#ffed4a');
    sunGradient.addColorStop(1, 'rgba(255, 237, 74, 0)');
    
    ctx.fillStyle = sunGradient;
    ctx.beginPath();
    ctx.arc(sunX, sunY, 50, 0, Math.PI * 2);
    ctx.fill();
    
    // Enhanced sun rays
    if (sunlightEl.checked) {
      ctx.strokeStyle = '#ffff0060';
      ctx.lineWidth = 2;
      for (let i = 0; i < 16; i++) {
        const angle = (i / 16) * Math.PI * 2;
        const x1 = sunX + Math.cos(angle) * 30;
        const y1 = sunY + Math.sin(angle) * 30;
        const x2 = sunX + Math.cos(angle) * 50;
        const y2 = sunY + Math.sin(angle) * 50;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      }
    }
    
    // Sun core
    ctx.fillStyle = '#ffff00';
    ctx.beginPath();
    ctx.arc(sunX, sunY, 25, 0, Math.PI * 2);
    ctx.fill();
    
    if (labelsEl.checked) {
      ctx.fillStyle = '#ffff00';
      ctx.font = 'bold 14px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('‚òÄÔ∏è SUN', sunX, sunY + 45);
    }
    
    // Enhanced orbit path
    if (orbitEl.checked) {
      ctx.strokeStyle = '#4a9eff40';
      ctx.lineWidth = 2;
      ctx.setLineDash([8, 4]);
      ctx.beginPath();
      ctx.arc(centerX, centerY, orbitRadius, 0, Math.PI * 2);
      ctx.stroke();
      ctx.setLineDash([]);
    }
    
    // Enhanced Earth with better details
    const earthGradient = ctx.createRadialGradient(centerX - 5, centerY - 5, 0, centerX, centerY, 20);
    earthGradient.addColorStop(0, '#6bb6ff');
    earthGradient.addColorStop(0.7, '#4a9eff');
    earthGradient.addColorStop(1, '#2980ef');
    
    ctx.fillStyle = earthGradient;
    ctx.beginPath();
    ctx.arc(centerX, centerY, 18, 0, Math.PI * 2);
    ctx.fill();
    
    // Earth continents (simplified)
    ctx.fillStyle = '#2d5016';
    ctx.beginPath();
    ctx.arc(centerX - 6, centerY - 3, 4, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(centerX + 4, centerY + 2, 3, 0, Math.PI * 2);
    ctx.fill();
    
    if (labelsEl.checked) {
      ctx.fillStyle = '#4a9eff';
      ctx.font = 'bold 14px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('üåç EARTH', centerX, centerY + 38);
    }
    
    // Calculate moon position
    const moonRad = (moonAngle * Math.PI) / 180;
    const moonX = centerX + Math.cos(moonRad) * orbitRadius;
    const moonY = centerY + Math.sin(moonRad) * orbitRadius;
    
    // Enhanced moon with realistic shading
    drawRealisticMoon(moonX, moonY, sunX, sunY);
    
    if (labelsEl.checked) {
      ctx.fillStyle = '#d4d4d8';
      ctx.font = 'bold 12px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('üåô MOON', moonX, moonY + 25);
    }
    
    // Earth shadow during eclipse
    if (earthShadowEl.checked && Math.abs(((moonAngle + 180) % 360) - 180) < 15) {
      ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
      ctx.beginPath();
      ctx.arc(moonX, moonY, 12, 0, Math.PI * 2);
      ctx.fill();
    }
    
    ctx.restore();
  }

  function drawRealisticMoon(moonX, moonY, sunX, sunY) {
    const moonRadius = 12;
    
    // Calculate illumination angle
    const sunAngle = Math.atan2(sunY - moonY, sunX - moonX);
    
    // Moon base
    ctx.fillStyle = '#d4d4d8';
    ctx.beginPath();
    ctx.arc(moonX, moonY, moonRadius, 0, Math.PI * 2);
    ctx.fill();
    
    // Moon craters for realism
    ctx.fillStyle = '#b8b8bc';
    ctx.beginPath();
    ctx.arc(moonX - 3, moonY - 2, 1.5, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(moonX + 2, moonY + 3, 1, 0, Math.PI * 2);
    ctx.fill();
    
    // Shadow based on sun position
    const phase = getPhaseInfo(moonAngle);
    if (phase.illumination < 100) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(moonX, moonY, moonRadius, 0, Math.PI * 2);
      ctx.clip();
      
      const shadowWidth = moonRadius * 2 * (1 - phase.illumination / 100);
      const shadowX = phase.normalizedAngle < 180 ? moonX - moonRadius : moonX + moonRadius - shadowWidth;
      
      ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
      ctx.fillRect(shadowX, moonY - moonRadius, shadowWidth, moonRadius * 2);
      ctx.restore();
    }
    
    // Moon glow
    if (phase.illumination > 0) {
      const glowGradient = ctx.createRadialGradient(moonX, moonY, moonRadius, moonX, moonY, moonRadius + 8);
      glowGradient.addColorStop(0, 'rgba(255, 255, 255, 0)');
      glowGradient.addColorStop(1, `rgba(255, 255, 255, ${phase.illumination / 500})`);
      ctx.fillStyle = glowGradient;
      ctx.beginPath();
      ctx.arc(moonX, moonY, moonRadius + 8, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function drawEarthView() {
    const centerX = W / 2;
    const centerY = H / 2;
    const moonSize = Math.min(W, H) * 0.25;
    
    // Starry background
    drawStars();
    
    // Draw realistic moon phase as seen from Earth
    const phase = getPhaseInfo(moonAngle);
    drawEarthViewMoon(centerX, centerY, moonSize, phase);
    
    // Phase name overlay
    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    ctx.font = 'bold 24px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(phase.phaseName, centerX, H - 50);
    
    ctx.font = '16px sans-serif';
    ctx.fillText(`${phase.illumination}% illuminated`, centerX, H - 25);
  }

  function drawStars() {
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    for (let i = 0; i < 50; i++) {
      const x = Math.random() * W;
      const y = Math.random() * H;
      const size = Math.random() * 1.5;
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function drawEarthViewMoon(x, y, size, phase) {
    const radius = size / 2;
    
    // Moon base
    ctx.fillStyle = '#e5e5e5';
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fill();
    
    // Add moon surface details
    ctx.fillStyle = '#d0d0d0';
    for (let i = 0; i < 8; i++) {
      const craterX = x + (Math.random() - 0.5) * radius * 1.5;
      const craterY = y + (Math.random() - 0.5) * radius * 1.5;
      const craterSize = Math.random() * 8 + 2;
      if (Math.pow(craterX - x, 2) + Math.pow(craterY - y, 2) < Math.pow(radius, 2)) {
        ctx.beginPath();
        ctx.arc(craterX, craterY, craterSize, 0, Math.PI * 2);
        ctx.fill();
      }
    }
    
    // Apply phase shadow
    if (phase.illumination < 100) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, Math.PI * 2);
      ctx.clip();
      
      const shadowWidth = radius * 2 * (1 - phase.illumination / 100);
      const shadowX = phase.normalizedAngle < 180 ? x - radius : x + radius - shadowWidth;
      
      ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
      ctx.fillRect(shadowX, y - radius, shadowWidth, radius * 2);
      ctx.restore();
    }
    
    // Moon glow
    if (phase.illumination > 10) {
      const glowGradient = ctx.createRadialGradient(x, y, radius, x, y, radius + 20);
      glowGradient.addColorStop(0, 'rgba(255, 255, 255, 0)');
      glowGradient.addColorStop(1, `rgba(255, 255, 255, ${phase.illumination / 300})`);
      ctx.fillStyle = glowGradient;
      ctx.beginPath();
      ctx.arc(x, y, radius + 20, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function draw() {
    ctx.fillStyle = 'rgba(10, 14, 26, 1)';
    ctx.fillRect(0, 0, W, H);
    
    if (isSpaceView) {
      drawSpaceView();
    } else {
      drawEarthView();
    }
  }

  function animate(currentTime) {
    if (isPlaying && lastTime > 0) {
      const deltaTime = (currentTime - lastTime) / 1000;
      moonAngle += orbitSpeed * deltaTime;
      moonAngle = moonAngle % 360;
      
      positionEl.value = Math.round(moonAngle);
      document.getElementById('lbl-position').textContent = Math.round(moonAngle);
      updatePhaseInfo();
    }
    lastTime = currentTime;
    
    draw();
    requestAnimationFrame(animate);
  }

  // Event listeners
  document.getElementById('btn-play').addEventListener('click', () => {
    isPlaying = true;
    lastTime = performance.now();
  });
  
  document.getElementById('btn-pause').addEventListener('click', () => {
    isPlaying = false;
  });
  
  document.getElementById('btn-reset').addEventListener('click', () => {
    isPlaying = false;
    moonAngle = 0;
    positionEl.value = 0;
    document.getElementById('lbl-position').textContent = '0';
    updatePhaseInfo();
  });

  positionEl.addEventListener('input', (e) => {
    moonAngle = parseFloat(e.target.value);
    document.getElementById('lbl-position').textContent = Math.round(moonAngle);
    updatePhaseInfo();
  });

  speedEl.addEventListener('input', (e) => {
    orbitSpeed = parseFloat(e.target.value);
    document.getElementById('lbl-speed').textContent = orbitSpeed;
  });

  document.getElementById('btn-space-view').addEventListener('click', () => {
    isSpaceView = true;
    document.getElementById('btn-space-view').classList.add('active');
    document.getElementById('btn-earth-view').classList.remove('active');
  });

  document.getElementById('btn-earth-view').addEventListener('click', () => {
    isSpaceView = false;
    document.getElementById('btn-earth-view').classList.add('active');
    document.getElementById('btn-space-view').classList.remove('active');
  });

  // Initialize
  updatePhaseInfo();
  requestAnimationFrame(animate);
})();


</script>

<script>
  (function(){
    const play = document.getElementById('playPauseBtn');
    const close = document.getElementById('closeBtn');
    if (play) play.addEventListener('click', () => { const btn = document.querySelector('#btn-animate, #btn-start'); if (btn) btn.click(); else window.isPlaying = !window.isPlaying; });
    if (close) close.addEventListener('click', () => { try { if (window.parent && window.parent !== window) { if (window.parent.clearAnimation) { window.parent.clearAnimation(); return; } } } catch(e){ console.warn('close action failed', e); } });
  })();
</script>

</body>
</html>